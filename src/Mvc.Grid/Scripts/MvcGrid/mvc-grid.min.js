/*!
 * Mvc.Grid 1.0.1
 * https://github.com/NonFactors/MVC.Grid
 *
 * Copyright © NonFactors
 *
 * Licensed under the terms of the MIT License
 * http://www.opensource.org/licenses/mit-license.php
 */
var MvcGrid=function(){function e(e,t){this.columns=[];this.element=e;t=t||{};this.name=e.data("name")||"";this.rowClicked=t.rowClicked;this.reloadEnded=t.reloadEnded;this.reloadFailed=t.reloadFailed;this.reloadStarted=t.reloadStarted;this.sourceUrl=e.data("source-url")||t.sourceUrl||"";this.gridQuery=t.query||window.location.search.replace("?","");if(t.reload===true||this.sourceUrl!=""&&!t.isLoaded){this.reload(this.gridQuery);return}this.filters=t.filters||{Text:new MvcGridTextFilter,Date:new MvcGridDateFilter,Number:new MvcGridNumberFilter,Boolean:new MvcGridBooleanFilter};var n=e.find(".mvc-grid-header");for(var r=0;r<n.length;r++){var i=this.createColumn($(n[r]));this.applyFiltering(i);this.applySorting(i);this.columns.push(i);this.cleanHeader(i)}var s=e.find(".mvc-grid-pager span");for(var o=0;o<s.length;o++){this.applyPaging($(s[o]))}this.bindGridEvents();this.cleanGrid(e)}e.prototype={createColumn:function(e){return{name:e.data("name")||"",header:e,filter:{isEnabled:e.data("filterable")=="True",name:e.data("filter-name")||"",type:e.data("filter-type")||"",val:e.data("filter-val")||""},sort:{isEnabled:e.data("sortable")=="True",firstOrder:e.data("sort-first")||"",order:e.data("sort-order")||""}}},set:function(e){this.filters=e.filters||this.filters;this.rowClicked=e.rowClicked||this.rowClicked;this.reloadEnded=e.reloadEnded||this.reloadEnded;this.reloadFailed=e.reloadFailed||this.reloadFailed;this.reloadStarted=e.reloadStarted||this.reloadStarted;if(e.reload===true){this.reload(this.gridQuery)}},applyFiltering:function(e){var t=this;if(e.filter.isEnabled){e.header.find(".mvc-grid-filter").bind("click.mvcgrid",function(){t.renderFilter(e)})}},applySorting:function(e){var t=this;if(e.sort.isEnabled){e.header.bind("click.mvcgrid",function(n){var r=$(n.target||n.srcElement);if(!r.hasClass("mvc-grid-filter")&&r.parents(".mvc-grid-filter").length==0){t.reload(t.formSortQuery(e))}})}},applyPaging:function(e){var t=e.data("page")||"";var n=this;if(t!=""){e.bind("click.mvcgrid",function(){n.reload(n.formPageQuery(t))})}},reload:function(e){var t=this;if(t.sourceUrl!=""){if(t.reloadStarted){t.reloadStarted(t)}var n;if(t.sourceUrl.indexOf("?")>-1)n=t.sourceUrl+"&"+e;else n=t.sourceUrl+"?"+e;$.ajax({url:n}).success(function(n){if(t.reloadEnded){t.reloadEnded(t)}t.element.hide();t.element.after(n);t.element.next(".mvc-grid").mvcgrid({reloadStarted:t.reloadStarted,reloadFailed:t.reloadFailed,reloadEnded:t.reloadEnded,rowClicked:t.rowClicked,sourceUrl:t.sourceUrl,filters:t.filters,isLoaded:true,query:e});t.element.remove()}).error(function(e){if(t.reloadFailed){t.reloadFailed(t,e)}})}else{window.location.href="?"+e}},renderFilter:function(e){var t=$("body").children(".mvc-grid-popup");var n=this.filters[e.filter.name];if(n){n.render(t,e.filter);n.init(this,e,t);this.setFilterPosition(e,t);t.addClass("open");$(window).bind("click.mvcgrid",function(e){var n=$(e.target||e.srcElement);if(!n.hasClass("mvc-grid-filter")&&n.parents(".mvc-grid-popup").length==0){$(window).unbind("click.mvcgrid");t.removeClass("open")}})}else{$(window).unbind("click.mvcgrid");t.removeClass("open")}},setFilterPosition:function(e,t){var n=e.header.find(".mvc-grid-filter");var r=t.find(".popup-arrow");var i=n.offset().left;var s=n.offset().top;var o=n.height();var u=$(window).width();var a=t.width();var f=s+o/2+14;var l=i-8;var c=15;if(i+a+5>u){l=u-a-14;c=i-l+7}r.css("left",c+"px");t.css("left",l+"px");t.css("top",f+"px")},formFilterQuery:function(e){var t=encodeURIComponent(this.name+"-"+e.name+"-"+e.filter.type);var n=encodeURIComponent(this.name+"-"+e.name);var r=encodeURIComponent(this.name+"-Page");var i=encodeURIComponent(e.filter.val);var s=this.gridQuery.split("&");var o=false;var u=[];for(var a=0;a<s.length;a++){if(s[a]!==""){var f=s[a].split("=")[0];if(f.indexOf(n)==0){s[a]=t+"="+i;o=true}if(f!=r){u.push(s[a])}}}if(!o){u.push(t+"="+i)}return u.join("&")},formFilterQueryWithout:function(e){var t=encodeURIComponent(this.name+"-"+e.name+"-"+e.filter.type);var n=encodeURIComponent(this.name+"-Page");var r=this.gridQuery.split("&");var i=[];for(var s=0;s<r.length;s++){if(r[s]!=""&&r[s].indexOf(t)!=0&&r[s].split("=")[0]!=n){i.push(r[s])}}return i.join("&")},formSortQuery:function(e){var t=this.addOrReplace(this.gridQuery,this.name+"-Sort",e.name);var n=e.sort.order=="Asc"?"Desc":"Asc";if(e.sort.order==""&&e.sort.firstOrder!=""){n=e.sort.firstOrder}return this.addOrReplace(t,this.name+"-Order",n)},formPageQuery:function(e){return this.addOrReplace(this.gridQuery,this.name+"-Page",e)},addOrReplace:function(e,t,n){n=encodeURIComponent(n);t=encodeURIComponent(t);var r=e.split("&");var i=false;var s=[];for(var o=0;o<r.length;o++){if(r[o]!==""){var u=r[o].split("=")[0];if(u==t){r[o]=t+"="+n;i=true}s.push(r[o])}}if(!i){s.push(t+"="+n)}return s.join("&")},bindGridEvents:function(){var e=this;this.element.find(".mvc-grid-row").bind("click.mvcgrid",function(){if(e.rowClicked){var t=$(this).find("td");var n=[];for(var r=0;r<e.columns.length;r++){var i=e.columns[r];if(t.length>r){n[i.name]=$(t[r]).text()}}e.rowClicked(e,this,n)}})},cleanHeader:function(e){var t=e.header;t.removeAttr("data-name");t.removeAttr("data-filterable");t.removeAttr("data-filter-name");t.removeAttr("data-filter-type");t.removeAttr("data-filter-val");t.removeAttr("data-sortable");t.removeAttr("data-sort-order");t.removeAttr("data-sort-first")},cleanGrid:function(e){e.removeAttr("data-source-url");e.removeAttr("data-name")}};return e}();var MvcGridTextFilter=function(){function e(){}e.prototype={render:function(e,t){var n=$.fn.mvcgrid.lang.Text;e.html('<div class="popup-arrow"></div>'+'<div class="popup-content">'+'<div class="popup-group">'+'<select class="form-control mvc-grid-type">'+'<option value="Contains"'+(t.type=="Contains"?' selected="selected"':"")+">"+n.Contains+"</option>"+'<option value="Equals"'+(t.type=="Equals"?' selected="selected"':"")+">"+n.Equals+"</option>"+'<option value="StartsWith"'+(t.type=="StartsWith"?' selected="selected"':"")+">"+n.StartsWith+"</option>"+'<option value="EndsWith"'+(t.type=="EndsWith"?' selected="selected"':"")+">"+n.EndsWith+"</option>"+"</select>"+"</div>"+'<div class="popup-group">'+'<input class="form-control mvc-grid-input" type="text" value="'+t.val+'">'+"</div>"+'<div class="popup-button-group">'+'<button class="btn btn-success mvc-grid-apply" type="button">&#10004;</button>'+'<button class="btn btn-danger mvc-grid-cancel" type="button">&#10008;</button>'+"</div>"+"</div>")},init:function(e,t,n){this.bindType(e,t,n);this.bindValue(e,t,n);this.bindApply(e,t,n);this.bindCancel(e,t,n)},bindType:function(e,t,n){var r=n.find(".mvc-grid-type");r.bind("change.mvcgrid",function(){t.filter.type=this.value});r.change()},bindValue:function(e,t,n){var r=n.find(".mvc-grid-input");r.bind("keyup.mvcgrid",function(e){t.filter.val=this.value;if(e.keyCode==13){n.find(".mvc-grid-apply").click()}})},bindApply:function(e,t,n){var r=n.find(".mvc-grid-apply");r.bind("click.mvcgrid",function(){n.removeClass("open");e.reload(e.formFilterQuery(t))})},bindCancel:function(e,t,n){var r=n.find(".mvc-grid-cancel");r.bind("click.mvcgrid",function(){n.removeClass("open");e.reload(e.formFilterQueryWithout(t))})}};return e}();var MvcGridNumberFilter=function(){function e(){}e.prototype={render:function(e,t){var n=$.fn.mvcgrid.lang.Number;e.html('<div class="popup-arrow"></div>'+'<div class="popup-content">'+'<div class="popup-group">'+'<select class="form-control mvc-grid-type">'+'<option value="Equals"'+(t.type=="Equals"?' selected="selected"':"")+">"+n.Equals+"</option>"+'<option value="LessThan"'+(t.type=="LessThan"?' selected="selected"':"")+">"+n.LessThan+"</option>"+'<option value="GreaterThan"'+(t.type=="GreaterThan"?' selected="selected"':"")+">"+n.GreaterThan+"</option>"+'<option value="LessThanOrEqual"'+(t.type=="LessThanOrEqual"?' selected="selected"':"")+">"+n.LessThanOrEqual+"</option>"+'<option value="GreaterThanOrEqual"'+(t.type=="GreaterThanOrEqual"?' selected="selected"':"")+">"+n.GreaterThanOrEqual+"</option>"+"</select>"+"</div>"+'<div class="popup-group">'+'<input class="form-control mvc-grid-input" type="text" value="'+t.val+'">'+"</div>"+'<div class="popup-button-group">'+'<button class="btn btn-success mvc-grid-apply" type="button">&#10004;</button>'+'<button class="btn btn-danger mvc-grid-cancel" type="button">&#10008;</button>'+"</div>"+"</div>")},init:function(e,t,n){this.bindType(e,t,n);this.bindValue(e,t,n);this.bindApply(e,t,n);this.bindCancel(e,t,n)},bindType:function(e,t,n){var r=n.find(".mvc-grid-type");r.bind("change.mvcgrid",function(){t.filter.type=this.value});r.change()},bindValue:function(e,t,n){var r=n.find(".mvc-grid-input");var i=this;r.bind("keyup.mvcgrid",function(e){t.filter.val=this.value;if(i.isValid(this.value)){$(this).removeClass("invalid");if(e.keyCode==13){n.find(".mvc-grid-apply").click()}}else{$(this).addClass("invalid")}});if(!i.isValid(t.filter.val)){r.addClass("invalid")}},bindApply:function(e,t,n){var r=n.find(".mvc-grid-apply");r.bind("click.mvcgrid",function(){n.removeClass("open");e.reload(e.formFilterQuery(t))})},bindCancel:function(e,t,n){var r=n.find(".mvc-grid-cancel");r.bind("click.mvcgrid",function(){n.removeClass("open");e.reload(e.formFilterQueryWithout(t))})},isValid:function(e){var t=new RegExp("^(?=.*\\d+.*)[-+]?\\d*[.,]?\\d*$");return t.test(e)}};return e}();var MvcGridDateFilter=function(){function e(){}e.prototype={render:function(e,t){var n='<input class="form-control mvc-grid-input" type="text" value="'+t.val+'">';var r=$.fn.mvcgrid.lang.Date;e.html('<div class="popup-arrow"></div>'+'<div class="popup-content">'+'<div class="popup-group">'+'<select class="form-control mvc-grid-type">'+'<option value="Equals"'+(t.type=="Equals"?' selected="selected"':"")+">"+r.Equals+"</option>"+'<option value="LessThan"'+(t.type=="LessThan"?' selected="selected"':"")+">"+r.LessThan+"</option>"+'<option value="GreaterThan"'+(t.type=="GreaterThan"?' selected="selected"':"")+">"+r.GreaterThan+"</option>"+'<option value="LessThanOrEqual"'+(t.type=="LessThanOrEqual"?' selected="selected"':"")+">"+r.LessThanOrEqual+"</option>"+'<option value="GreaterThanOrEqual"'+(t.type=="GreaterThanOrEqual"?' selected="selected"':"")+">"+r.GreaterThanOrEqual+"</option>"+"</select>"+"</div>"+'<div class="popup-group">'+n+"</div>"+'<div class="popup-button-group">'+'<button class="btn btn-success mvc-grid-apply" type="button">&#10004;</button>'+'<button class="btn btn-danger mvc-grid-cancel" type="button">&#10008;</button>'+"</div>"+"</div>")},init:function(e,t,n){this.bindType(e,t,n);this.bindValue(e,t,n);this.bindApply(e,t,n);this.bindCancel(e,t,n)},bindType:function(e,t,n){var r=n.find(".mvc-grid-type");r.bind("change.mvcgrid",function(){t.filter.type=this.value});r.change()},bindValue:function(e,t,n){var r=n.find(".mvc-grid-input");if($.fn.datepicker){r.datepicker()}r.bind("change.mvcgrid keyup.mvcgrid",function(e){t.filter.val=this.value;if(e.keyCode==13){n.find(".mvc-grid-apply").click()}})},bindApply:function(e,t,n){var r=n.find(".mvc-grid-apply");r.bind("click.mvcgrid",function(){n.removeClass("open");e.reload(e.formFilterQuery(t))})},bindCancel:function(e,t,n){var r=n.find(".mvc-grid-cancel");r.bind("click.mvcgrid",function(){n.removeClass("open");e.reload(e.formFilterQueryWithout(t))})}};return e}();var MvcGridBooleanFilter=function(){function e(){}e.prototype={render:function(e,t){var n=$.fn.mvcgrid.lang.Boolean;e.html('<div class="popup-arrow"></div>'+'<div class="popup-content">'+'<div class="popup-group">'+'<ul class="mvc-grid-boolean-filter">'+"<li "+(t.val=="True"?'class="active" ':"")+'data-value="True">'+n.Yes+"</li>"+"<li "+(t.val=="False"?'class="active" ':"")+'data-value="False">'+n.No+"</li>"+"</ul>"+"</div>"+'<div class="popup-button-group">'+'<button class="btn btn-success mvc-grid-apply" type="button">&#10004;</button>'+'<button class="btn btn-danger mvc-grid-cancel" type="button">&#10008;</button>'+"</div>"+"</div>")},init:function(e,t,n){this.bindValue(e,t,n);this.bindApply(e,t,n);this.bindCancel(e,t,n)},bindValue:function(e,t,n){var r=n.find(".mvc-grid-boolean-filter li");t.filter.type="Equals";r.bind("click.mvcgrid",function(){var e=$(this);t.filter.val=e.data("value");e.siblings().removeClass("active");e.addClass("active")})},bindApply:function(e,t,n){var r=n.find(".mvc-grid-apply");r.bind("click.mvcgrid",function(){n.removeClass("open");e.reload(e.formFilterQuery(t))})},bindCancel:function(e,t,n){var r=n.find(".mvc-grid-cancel");r.bind("click.mvcgrid",function(){n.removeClass("open");e.reload(e.formFilterQueryWithout(t))})}};return e}();$.fn.mvcgrid=function(e){return this.each(function(){if(!$.data(this,"mvc-grid")){$.data(this,"mvc-grid",new MvcGrid($(this),e))}else if(e){$.data(this,"mvc-grid").set(e)}})};$.fn.mvcgrid.lang={Text:{Contains:"Contains",Equals:"Equals",StartsWith:"Starts with",EndsWith:"EndsWith"},Number:{Equals:"Equals",LessThan:"Less than",GreaterThan:"Greater than",LessThanOrEqual:"Less than or equal",GreaterThanOrEqual:"Greater than or equal"},Date:{Equals:"Equals",LessThan:"Less than",GreaterThan:"Greater than",LessThanOrEqual:"Less than or equal",GreaterThanOrEqual:"Greater than or equal"},Boolean:{Yes:"Yes",No:"No"}};$(function(){$("body").append('<div class="mvc-grid-popup"></div>');$(window).resize(function(){$(".mvc-grid-popup").removeClass("open")});$(".mvc-grid").mvcgrid()})
